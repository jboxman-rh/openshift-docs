[id="using-rest-api"]
= Using the REST API
include::modules/common-attributes.adoc[]
:context: using-rest-api

toc::[]

You can use the REST APIs to manage end-user applications, the cluster, and the users of the cluster.

[id="using-rest-api-authentication"]
== Authentication

To use the REST API, you must authenticate with an access token or X.509 certificate.

// https://docs.openshift.com/container-platform/4.6/authentication/understanding-authentication.html
// https://docs.openshift.com/container-platform/4.6/authentication/understanding-and-creating-service-accounts.html
// https://docs.openshift.com/container-platform/4.6/authentication/using-service-accounts-as-oauth-client.html
// Others?

This section highlights the token authentication method. With token authentication, a bearer token must be passed in as an link:https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.8[HTTP Authorization header]. There are two types of access tokens: session and service account.

[id="using-rest-api-session-tokens"]
=== Session Tokens

A _session token_ is short-lived, expiring within 24 hours by default. It
represents a user.
After logging in, the session token may be obtained with the `oc whoami`
command:

[source,terminal]
----
$ oc whoami -t
----

[id="using-rest-api-service-account-tokens"]
=== Service Account Tokens

_Service account tokens_ are long-lived tokens. They are
link:https://tools.ietf.org/html/rfc7519[JSON Web Token (JWT)] formatted tokens
and are much longer strings than session tokens. See
xref:../dev_guide/service_accounts.adoc#using-a-service-accounts-credentials-externally[Using
a Service Accountâ€™s Credentials Externally] for steps on using these tokens to
authenticate using the CLI.

A service account token may be obtained with these commands:

. Create a service account in the current project (*test*) named *robot*:
+
[source,terminal]
----
$ oc create serviceaccount robot
serviceaccount "robot" created
----

. Grant a role to the service account. In this example, assign the *robot* service
account in the *test* project the *admin* role:
+
[source,terminal]
----
$ oc policy add-role-to-user admin system:serviceaccount:robot
----

. Get the token value:
+
----
$ oc serviceaccounts get-token robot
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJpc3YtY2VydCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJpbWctYnVpbGQtdG9rZW4teG1rMHciLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiaW1nLWJ1aWxkIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYTJmNzM0NWMtNDA4Zi0xMWU3LTg1NTktMDAxYTRhZTBkZjQ1Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omlzdi1jZXJ0OmltZy1idWlsZCJ9.Xt5cc9k7fucc7ZAYqt6cz6WvyDhbCZcfHXH-Ow6vStI4Gy7dS3qxIewcXFw8-h1_wkLRUYvyVVYDCRIIbmWL68ybzY2ND8FyuQwCOWP-2_vFvm8xmpjFURZwuNv-eGULNwzOfrSCIelqM2ImCYcM3tpbnyMPeW_KoSI4LGKxXZZqBIcpa9Xb0Zr225uhpZJ2tb_ItuqdOXPUC0GZdHbpbCI0I-Yu-IudCRBHZZ_2SlAi3vbJcvmjpXHfaz49enR602S8ztXF4gXG4_lXa0fS5QYtB0lnIv9q8HXzxKioG_P3O1yD1HqdLYXhZaMNDyg1Xm-5hAkfQ4A7UMPgK4a2zg
----

The token value may be used in an authorization header to
xref:rest-api-examples[authenticate API calls], the
xref:../dev_guide/service_accounts.adoc#using-a-service-accounts-credentials-externally[CLI]
or in the xref:rest-api-docker-login[docker login command]. Service accounts may
be created and deleted as needed with the appropriate role(s) assigned. See
xref:../architecture/additional_concepts/authorization.adoc#roles[Authorization]
in the Architecture documentation for a deeper discussion on roles.

[[rest-api-index-examples]]
== Examples

These examples provide a quick reference for making successful REST API calls.
They use insecure methods. In these examples, a simple `GET` call is made to
list available resources.

[[rest-api-example-curl]]
=== cURL

.Request (Insecure)
----
$ octoken=$(oc serviceaccounts get-token robot)
$ curl -H "Authorization: Bearer $octoken" "https://api.example.com:6443/apis/user.openshift.io/v1/users/~" --insecure
----

.Result (Truncated)
----
{
  "kind": "APIResourceList",
  "groupVersion": "v1",
  "resources": [
    {
      "name": "buildconfigs",
      "namespaced": true,
      "kind": "BuildConfig"
    },
    {
      "name": "buildconfigs/instantiate",
      "namespaced": true,
      "kind": "BuildRequest"
    },
    {
      "name": "buildconfigs/instantiatebinary",
      "namespaced": true,
      "kind": "BinaryBuildRequestOptions"
    },
    {
      "name": "buildconfigs/webhooks",
      "namespaced": true,
      "kind": "Status"
    },
    {
      "name": "builds",
      "namespaced": true,
      "kind": "Build"
    },
    ...
    {
      "name": "subjectaccessreviews",
      "namespaced": true,
      "kind": "SubjectAccessReview"
    },
    {
      "name": "templates",
      "namespaced": true,
      "kind": "Template"
    },
    {
      "name": "useridentitymappings",
      "namespaced": false,
      "kind": "UserIdentityMapping"
    },
    {
      "name": "users",
      "namespaced": false,
      "kind": "User"
    }
  ]
}
----

[[rest-api-example-python]]
=== Python

.Interactive Python API Call Using "requests" Module (Insecure)
----
>>> import requests
>>> url = 'https://openshift.redhat.com:8443/oapi/v1'
>>> headers = {'Authorization': 'Bearer dIAo76N-W-GXK3S_w_KsC6DmH3MzP79zq7jbMQvCOUo'}
>>> requests.get(url, headers=headers, verify=False)
/usr/lib/python2.7/site-packages/requests/packages/urllib3/connectionpool.py:791: InsecureRequestWarning: Unverified HTTPS request is being made. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.org/en/latest/security.html
  InsecureRequestWarning)
<Response [200]>
----

ifdef::openshift-enterprise,openshift-origin[]
[[rest-api-image-signatures]]
== Image Signatures

The OpenShift Container Registry allows the users to manipulate the image
signatures using its own API. See
xref:../admin_guide/image_signatures.adoc#accessing-image-signatures-using-registry-api[Accessing Image Signatures Using Registry API] for more information.
endif::[]

[[rest-api-websockets]]
== Websockets and Watching for Changes

The API is designed to work via the
link:https://tools.ietf.org/html/rfc6455[websocket protocol]. API requests may
take the form of "one-shot" calls to list resources or by passing in query
parameter `watch=true`. When watching an endpoint, changes to the system may be
observed through an open endpoint. Using callbacks, dynamic systems may be
developed that integrate with the API.

For more information and examples, see the Mozilla Developer Network page on
link:https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_client_applications[Writing
WebSocket client applications].

// Legacy

= Rest API Examples

This page includes usage examples for OpenShift's REST API. The examples are presented as link:https://curl.haxx.se/[curl] and link:https://stedolan.github.io/jq/[jq] command calls. The examples are parameterised using environment variables as follows:

[options="header",cols="1,3"]
|===
| Environment variable
| Purpose

| TOKEN
| Authentication token for OpenShift. If using X.509 authentication, remove lines
referencing $TOKEN and provide a client certificate and key instead. For
example, the curl `--cert` and `--key` arguments.

| ENDPOINT
| TCP endpoint of OpenShift API server, such as 127.0.0.1:8443. Without loss of
generality, in these examples it is assumed that the API server is presented by
HTTPS and that it may be accessed insecurely.

| NAMESPACE
| Namespace to use for namespaced objects.
|===

To try out the usage examples by copy/paste, first set all of the previously mentioned environment variables, for example:

----
TOKEN=$(oc whoami -t)
ENDPOINT=$(oc config current-context | cut -d/ -f2 | tr - .)
NAMESPACE=$(oc config current-context | cut -d/ -f1)
----

[[template-instantiation]]
== Template Instantiation

<<apis-template.openshift.io/v1.Template.adoc#,Templates>> include one or more
objects to be instantiated, as well as optionally specifying parameters to be
used at instantiation time. The flow to instantiate a
<<apis-template.openshift.io/v1.Template.adoc#,Template>> using the
<<apis-template.openshift.io/v1.TemplateInstance.adoc#,TemplateInstance>> API
follows:

. To set any parameter values (e.g. to override default values specified in the
   <<apis-template.openshift.io/v1.Template.adoc#,Template>> or to specify
   parameter values which have no defaults),
   <<api/v1.Secret.adoc#Post-api-v1-namespaces-namespace-secrets,create a Secret>>
   containing the necessary values.
+
----
$ curl -k \
    -X POST \
    -d @- \
    -H "Authorization: Bearer $TOKEN" \
    -H 'Accept: application/json' \
    -H 'Content-Type: application/json' \
    https://$ENDPOINT/api/v1/namespaces/$NAMESPACE/secrets <<'EOF'
{
  "kind": "Secret",
  "apiVersion": "v1",
  "metadata": {
    "name": "secret"
  },
  "stringData": {
    "NAME": "example"
  }
}
EOF
----

. <<apis-template.openshift.io/v1.TemplateInstance.adoc#Post-apis-template.openshift.io-v1-namespaces-namespace-templateinstances,Create a TemplateInstance>>
   containing the whole template you want to instantiate, and a reference to the
   <<api/v1.Secret.adoc#,Secret>> created above.
+
----
$ curl -k \
    -X POST \
    -d @- \
    -H "Authorization: Bearer $TOKEN" \
    -H 'Accept: application/json' \
    -H 'Content-Type: application/json' \
    https://$ENDPOINT/apis/template.openshift.io/v1/namespaces/$NAMESPACE/templateinstances <<EOF
{
  "kind": "TemplateInstance",
  "apiVersion": "template.openshift.io/v1",
  "metadata": {
    "name": "templateinstance"
  },
  "spec": {
    "secret": {
      "name": "secret"
    },
    "template": $(curl -k \
                    -H "Authorization: Bearer $TOKEN" \
                    -H 'Accept: application/json' \
                    https://$ENDPOINT/apis/template.openshift.io/v1/namespaces/openshift/templates/cakephp-mysql-example)
  }
}
EOF
----

. <<apis-template.openshift.io/v1.TemplateInstance.adoc#Get-apis-template.openshift.io-v1-namespaces-namespace-templateinstances-name,Poll the TemplateInstance>>
   or
   <<apis-template.openshift.io/v1.TemplateInstance.adoc#Get-apis-template.openshift.io-v1-watch-namespaces-namespace-templateinstances-name,watch the TemplateInstance>>
   until either the `Ready` or `InstantiateFailure` condition types report
   status `True`.
+
----
$ while ! curl -s -k \
            -H "Authorization: Bearer $TOKEN" \
            -H 'Accept: application/json' \
            https://$ENDPOINT/apis/template.openshift.io/v1/namespaces/$NAMESPACE/templateinstances/templateinstance | \
          jq -e '.status.conditions[] | select(.status == "True") | .type'; do
    sleep 1
  done
----
