[id="about-network-policy"]
= About network policy
include::modules/common-attributes.adoc[]
:context: about-network-policy

toc::[]

As a cluster administrator, you can define network policies that restrict traffic to pods in your cluster.

What follows is a discussion of how network traffic isolation works with network policy.

[#use-of-network-policy]
== Use of network policy

As a cluster or project administrator, you can use a network policy to create allow lists for ingress or egress traffic between pods and from or to specific IP address blocks. You can further restrict traffic by specifying ports and network protocols.

A network policy consists of two parts:

* Isolation selector: Describe which pods the network policy isolates
* Policy rule selectors: Describe what traffic is allowed to or from the isolated pods

You cannot use DNS names with network policy.

.Network policy object
[source,yaml]
----
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
spec:
  podSelector: <.>
  ingress: []
  egress: []
  policyTypes:
  - Ingress
  - Egress
----
<.> Isolation selector.
<.> Optional: Ingress policy rule selectors.
<.> Optional: Egress policy rule selectors.
<.> Optional: Policy types defined by the network policy. If not specified, the default value is `Ingress`.

[#requirements-for-network-policy]
== Requirements for network policy

Your cluster must use a network provider that supports the use of network policy, such as OVN-Kubernetes or OpenShift SDN with network policy isolation mode configured.

[NOTE]
====
When using the OpenShift SDN cluster network provider, the following limitations apply regarding network policies:

* Egress network policy as specified by the `egress` field is not supported.
* IPBlock is supported by network policy, but without support for `except` clauses. If you create a policy with an IPBlock section that includes an `except` clause, the SDN pods log warnings and the entire IPBlock section of that policy is ignored.
====

[#limitations-of-network-policy]
== Limitations of network policy

The following limitations apply to the use of network policy:

* Network policy does not apply to the host network namespace. Pods with host networking enabled are unaffected by network policy rules.

[#roles-authorized-to-specify-network-policy]
== Roles authorized to specify network policy

By default, the following roles can create, edit, and delete a network policy:

* `cluster-admin`
* `admin`

[#types-of-network-traffic-supported]
== Types of network traffic supported

You can use specify a network policy for only TCP, UDP, and SCTP traffic types.

[#types-of-network-policy]
== Types of network policy

Network policy supports the following policy types:

* Ingress
* Egress

A network policy can contain both ingress and egress network policy rules.

.Example network policy that uses both policy types
[source,yaml]
----
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: example-ingress-egress
spec:
  podSelector:
  policyTypes:
  - Ingress
  - Egress
----

Policy types are unidirectional. If you define both ingress and egress policies for your cluster, traffic must be allowed for both ingress and egress for network traffic between pods. For example, if an ingress network policy rule allows a destination pod to receive traffic from a source pod, but the source pod is restricted from communicating with the destination pod with an egress network policy rule, the connection is blocked.

If you are using the OpenShift SDN cluster network provider, only the ingress policy type is supported.

[#policy-scope]
== Policy scope

A network policy is scoped to a specific namespace and can be further limited to a specific subset of pods in that namespace.

If multiple network policies are defined in a namespace they are applied additively, which means network policies can be created in any order.

[#policy-isolation]
== Policy isolation

Depending on how you specify your network policies, a network policy can apply to the following network traffic:

* Traffic between pods in the same namespace
* Traffic between pods in different namespaces
* Traffic from an IP address block to a pod
* Traffic to an IP address block from a pod

[#selectors]
== Selectors

A network policy uses selectors in two ways:

* To select the pods that the policy isolates
* To select which traffic from a pod or to a pod to allow

[#select-pods-that-a-policy-isolates]
=== Select pods that a policy isolates

If you specify an empty selector then all pods in a namespace are selected.

[source,yaml]
----
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: empty-pod-selector
spec:
  podSelector:
  ingress: []
  policyTypes:
  - Ingress
----

[#select-pods-that-a-policy-rule-applies-to]
=== Select pods that a policy rule applies to

When you specify a network policy rule, you use selectors to:

* Specify the namespaces that ingress and egress rules apply to
* Specify the pods in a selected namespace to apply to

The specific behavior for policy rule selectors is as follows:

* If only a namespace selector is used then a policy rule applies to all pods in that namespace.
* If only a pod selector is used then a policy rule applies to only the namespace in which the network policy is defined.
* If both a namespace selector and pod selector are used in a policy rule then only pods that satisfy both selectors are selected.

NOTE: A namespace does not have a label by default. To add a label to a namespace as a target for a namespace selector, add a label such as with the `oc label namespace <name> networking/namespace=<name>` command. Replace `<name>` with the name of the namespace the label is applied to.

NOTE: Beginning with {product-title} 4.8, which is based on Kubernetes 1.21, the following label is added automatically to each namespace:

[source,yaml]
----
metadata:
  name: <name>
  labels:
    kubernetes.io/metadata.name: <name>
----

[#available-selector-policy-groups]
=== Available selector policy groups

Several namespace selectors are available in {product-title}:

`network.openshift.io/policy-group: ingress`:: Selects all Ingress Controller pods.
`network.openshift.io/policy-group: monitoring`:: Selects all monitoring pods.
`policy-group.network.openshift.io/host-network`: "":: Selects all host network traffic. You cannot combine this namespace selector with a pod selector.

[#policy-rules]
== Policy rules

A network policy must specify one or more policy rules that describe what ingress or egress traffic is permitted for pods that the network policy isolates.

[#policy-isolation-behavior]
=== Policy isolation behavior

A pod that is isolated is one that is selected by at least one network policy rule. When you use network policy to isolate your pods, the following considerations apply:

* If a namespace does not have any network policy ingress rules defined then all ingress traffic is allowed to all pods in that namespace
* If a namespace does not have any network policy egress rules defined then all egress traffic is allowed from all pods in that namespace

If a namespace does have network policy rules defined then the following applies:

* If a pod is not selected by any ingress network policy rule selectors, then all ingress traffic is allowed to that pod
* If a pod is not selected by any egress network policy rule selectors, then all egress traffic is allowed from that pod

IMPORTANT: To ensure that pods are isolated by default, it is recommended to always create a deny ingress by default network policy that selects all pods in the namespace.

[#policy-rule-logical-ordering]
=== Policy rule logical ordering

In a single network policy one or more policy rules can be defined. The following logic applies when evaluating an array of one or more ingress or egress policy rules:

* If a policy rule includes both a namespace selector and a pod selector, both selectors are evaluated with a logical `and`
* If multiple policy rules are defined, each policy is evaluated with a logical `or`

[#policy-rule-precedence]
=== Policy rule precedence

Any network policy rule that denies either ingress or egress traffic for a pod is always superseded by a policy rule that allows that traffic.

For example, if your cluster defines the following network policy, ingress traffic is allowed on port `80` to the pod with the `app=web` label.

[source,yaml]
----
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: web-deny-all
spec:
  podSelector:
    matchLabels:
      app: web
  ingress: []
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: web-allow-http
spec:
  podSelector:
    matchLabels:
      app: web
  ingress:
    from:
    - {}
    ports:
    - port: 80
----

[#policy-rule-behavior-with-an-empty-selector]
=== Policy rule behavior with an empty selector

If you specify an empty selector, the behavior of network policy is as follows:

* For the pods that the network policy isolates:
 ** The policy applies to all pods in the namespace where the network policy is defined
* For the pods that a network policy rule targets:
 ** If a network policy ingress or egress rule specifies an empty namespace selector, the policy applies to all namespaces
 ** If a network policy ingress or egress rule specifies an empty pod selector, the policy applies to all pods in any selected namespace, or in all namespaces if no namespace selector is specified

TODO - why did I include this here?

[source,yaml]
----
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: deny-all-ingress
spec:
  podSelector: {}
  ingress: []
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: allow-all-https
spec:
  podSelector: {}
  ingress:
    ports:
    - port: 443
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: allow-only-db-https
spec:
  podSelector: {}
  ingress:
    from:
    - namespaceSelector:
        matchLabels:
          app: db
      ports:
      - port: 443
----

[#policy-rule-behavior-with-an-empty-ingress-or-egress-rule-set]
=== Policy rule behavior with an empty ingress or egress rule set

If you define a network policy with an empty list for an ingress or egress rule set, the network policy does not match any traffic. For example, the following ingress rule set selects no ingress traffic:

.Example ingress ruleset defined as an empty list
[source,yaml]
----
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
spec:
  ingress: []
----

An empty rule set is the inverse of a rule set with a single empty selector, which selects all traffic. For example, the following ingress rule set selects all ingress traffic:

.Example ingress ruleset with a single empty selector
[source,yaml]
----
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
spec:
  ingress:
  - {}
----

The previous example is identical in behavior to the following example:

.Example ingress ruleset that matches all ingress traffic
[source,yaml]
----
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
spec:
  ingress:
  - from:
    - podSelector: {}
      namespaceSelector: {}
----

=== Policy rule for an IP address block

In addition to selectors for pods and namespaces, you can define a network policy rule that selects an IP address block specified in CIDR form. Optionally, you can exclude one or more subsets of the IP address block.

.Example ingress rule that matches an IP address block
[source,yaml]
----
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
spec:
  ingress:
  - from:
    - ipBlock:
        cidr: 172.17.0.0/16
        except:
        - 172.17.1.0/24
----

[#nework-policy-api]
== Nework policy API

When you specify network policy, you use the `NetworkPolicy` API in the `networking.k8s.io` API group.

TODO: Various network policy API tables.

//include::modules/nw-networkpolicy-about.adoc[leveloffset=+1]
//include::modules/nw-networkpolicy-optimize.adoc[leveloffset=+1]

[id="about-network-policy-next-steps"]
== Next steps

* xref:../../networking/network_policy/creating-network-policy.adoc#creating-network-policy[Creating a network policy]
* Optional: xref:../../networking/network_policy/default-network-policy.adoc#default-network-policy[Defining a default network policy]

[id="about-network-policy-additional-resources"]
== Additional resources

* xref:../../networking/network_policy/multitenant-network-policy.adoc#multitenant-network-policy[Configuring multitenant network policy]
* xref:../../rest_api/network_apis/networkpolicy-networking-k8s-io-v1.adoc#networkpolicy-networking-k8s-io-v1[NetworkPolicy API]
